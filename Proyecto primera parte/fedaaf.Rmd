---
title: "Trabajo de FEDAF"
author: "Jaume Joan Ballester Servera"
date: "18 de junio de 2019"
output: html_document
---
```{r}
data = load("C:/Users/jaume/Downloads/us_1960_2018.Rdata")
View(data)
```

```{r}
library(stats)
library(tseries)
library(forecast)
library(rugarch) 
library(copula)

```

Ejercicio 1
1. Gráficos de niveles y de las primeras diferencias, las ACFs, PACFs, interprétalos
```{r}
plot(lgnp) #Grafico de niveles

dif = diff(lgnp)
dif #Primeras diferencias
plot(dif)

par(mfrow=c(1,3))
ts.plot(lgnp)
acfs  = acf(lgnp)
pacfs = pacf(lgnp)
#Grafico sin diferneciar que se puede ver que es estacionario ( por los 3 plots)

par(mfrow=c(1,3)) #meter el descompose !!!!!!!!!!!
ts.plot(dif)
acfs  = acf(dif)
pacfs = pacf(dif)
#vemos que cuando diferenciamos ya no es estacionario

#Contraste
adf.test(diff(lgnp), alternative="stationary", k=0)
#Como se puede observar, después de diferenciar la serie, ahora sí es estacionaria; un p-valor de 0.01, indica que rechazamos la hipótesis nula de no estacionariedad.

```

2. Comprueba si las series (niveles y primeras diferencias) son estacionarias, en cada caso escribe
hipótesis cero y alternativas, interpreta los resultados del contraste.

```{r}
#Contraste
adf.test((lgnp), alternative="stationary", k=0)
adf.test(diff(lgnp), alternative="stationary", k=0)
#Como se puede observar, después de diferenciar la serie, ahora sí es estacionaria; un p-valor de 0.01, indica que rechazamos la hipótesis nula de no estacionariedad.

```

3. Ajusta el modelo ARMA sobre la serie estacionaria, justifica la elecci´on del orden del modelo.
Interpreta los par´ametros estimados y comenta sobre su significación estadística.
```{r}
m1 = arima(dif, order = c(0, 0,2),include.mean = TRUE) 
ts.plot(m1$residuals)
acfs  = acf(m1$residuals)
pacfs = pacf(m1$residuals)
m1
```

4. Analiza los residuos del modelo en 3. (normalidad, autocorrelaci´on, efectos ARCH), discute
la bondad del ajuste del modelo propuesto en 3. y posibles defectos.

```{r}
#Normalidad
grid = seq(-10,10,length=500)
hist(m1$residuals/sqrt(m1$sigma2),freq=FALSE)
lines(grid,dnorm(grid))


#ARCH
#La volatilidad es una característica inherente a las series de tiempo financieras. En general, no es constante y en consecuencia los modelos de series de tiempo tradicionales que suponen varianza homocedástica, no son adecuados para modelar series de tiempo financieras. Engle (1982) introduce una nueva clase de procesos estocásticos llamados modelos ARCH, en los cuales la varianza condicionada a la información pasada no es constante, y depende del cuadrado de las innovaciones pasadas

spec = ugarchspec()
fit = ugarchfit(data = lgnp, spec = spec)
fit
#Aqui ya veo que no hay correlación

#Estimación fuera de la muestrafit = ugarchfit(data = lgnp, spec = spec,out.sample=4)
forc=ugarchforecast(fit, n.ahead=4)
plot(forc)
```
5. Predice el crecimiento del PIB en % (tasa anualizada) 2019Q4.

```{r}
#Estimación fuera de la muestrafit = ugarchfit(data = lgnp, spec = spec,out.sample=4)
forc=ugarchforecast(fit, n.ahead=4)
plot(forc)
```

EJERCICI 2

1. Analiza si las cuatro series en sus niveles y las primeras diferencias son estacionarias mediante inspecci´on gr´afica y contrastes sobre estacionaridad.

```{r}
n= data.frame(lgnp, gs10, lm1s, tb3m)

series<-ts(n,frequency=4,start=1960)

ts.plot((n[1:4]))
#Con diferencias
n2= data.frame(diff(lgnp), diff(gs10), diff(lm1s), diff(tb3m))
series2<-ts(n2,frequency=4,start=1960)

ts.plot((n2[1:4]))

#contraste

adf.test(diff(lgnp), alternative="stationary", k=0) #con todos
```



2. Prop´on un modelo VAR para las series diferenciadas, justifica la elecci´on del orden del modelo.

```{r}
#Eligo un VAR 2
library(vars)
modelo<-vars::VAR(diff(series),p=5)
modelo


modelo

summary(modelo)

```


3. Comprueba si el VAR estimado es estacionario.

```{r}
#Miro si el var es estacionario o no

acf(residuals(modelo))
acf(residuals(modelo)[,4])
pacf(residuals(modelo)[,4])
roots(modelo)#de forma más teorica
#La comprobación de la estabilidad no indica que nuestro modelo este mal
```

4. Analiza los residuos (normalidad, autocorrelaci´on, efectos ARCH), discute la bondad del ajuste del modelo propuesto y posibles defectos.

```{r}
#Autocorrelación de las residuos

#Prueba Portmanteau Multivariada
serial.test(modelo,lags.pt=10)
#Prueba de Breusch-Godfrey
serial.test(modelo,lags.bg=10)

#Prueba de normalidad
normality.test(modelo, multivariate.only=FALSE)

#Para la bondad no se si hay que hacer un histogrma o con esto es suficiente para llegar a conclusiones
hist(residuals(modelo))

#ARCH     NO TIRA 
spec = ugarchspec()
fit = ugarchfit(data = modelo, spec = spec)
fit
archvar = arch.test(modelo,lags.multi = 5)
archvar

```


5. Calcula, dibuja e interpreta las funciones de respuesta al impulso para 12 pasos delante suponiendo que: a) los residuos no son correlacionados; b) los residuos son correlacionados. Explica las diferencias entre a) y b).

```{r}
#Modelo al impulso
modelo.irf<-irf(modelo, lag = 12) 
plot(modelo.irf)#Nose como ponerlo... tiene que haber una propiedad en esta formula o en alguna otra

#modelo.irf<-irf(modelo,impulse="x", response="y")
#modelo.irf2<-irf(modelo,impulse="x", response="x")
```

1. Confirma que todas las series son I(1).

```{r}
#Para decir que son I(1) basta decir que son no estacionarios
#n-1 relaciones de cointegración

df.test1=ur.df(diff(lgnp), type=c("drift"),lags=0) #con todas
summary(df.test1)

```


2. Realiza el contraste de cointegraci´on de Johansen (las dos versiones), interpreta los resultados
de las pruebas.

```{r}
library("MTS")
VARorder(n2,maxp=10)

johansen<-ca.jo(n2, type="eigen",spec="transitory",ecdet="none",K=4)
summary(johansen)

vecm1<-cajorls(johansen,r=3)
vecm1

summary(vecm1$rlm)
```


3. En caso de la(-s) relaci´on(-es) de las relaciones de cointegraci´on, construye la(-s) serie(-s) de
cointegraci´on, pres´entala(-s) gr´aficamente, comprueba si es(son) estacionaria(-s).


4. Utilizando la funci´on vec2var convierte el objecto del apartado 2. a un modelo VAR con
el rango de cointegraci´on elegido en 2. y dibuja e interpreta las funciones de la respuesta al
impulso.
