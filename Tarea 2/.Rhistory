if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),][1,1]) == F &
is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),][1,1]) == F){
prof202[n, r] = sum(sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$quote),
sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$quote))/2
}else{break}
r = r - 1
}
prof_ocul202[n, 1] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 2] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(1,11)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 3] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(2,12)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 4] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(3,13)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 5] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(4,14)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 6] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(5,15)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 7] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(6,16)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 8] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(7,17)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 9] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(8,18)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 10] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(9,19)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul202[n, 11] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(10,20)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
n = n + 1
}
}
cont = 0
stock = read_tsv("Stock203LOB.txt")
#Se crean todas las variables que serán necesarias en el algoritmo
hor_rel203 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
prof203 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 4)
prof_ocul203 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 11)
q = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 1)
a = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
b = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
n = 1
#Cálculo horquilla relativa
for (i in 1:length(unique(stock$date))){
for (j in 1:length(unique(stock$time))){
#Variable creada para facilitar el almacenamiento en la matriz
m=1
#Cálculo del punto medio.
for(l in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign > 0),][l,]$dvol != 0){
for(p in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$dvol != 0){
q[n] = (stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$quote)/2
break
}
}
break
}
}
for (k in c(100,500,1000)){
for(l in 1:10){
#Cálculo del bid ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$hvol)  >= k){
b[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol)))/k
break
}else if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3] == -1){
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3])){break}
for(l in 1:10){
#Cálculo ask ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$hvol)  >= k){
a[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol)))/k
break
}else{
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
#Cálculo de la horquilla relativa
hor_rel203[n, m] = (a[n, m] - b[n, m])/q[n]
m = m + 1
}
cont = cont + 1
print(cont)
#Cálculo de la profundidad cotizada
r = 4
for (k in c(0.2, 0.1, 0.05, 0.01)){
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),][1,1]) == F &
is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),][1,1]) == F){
prof203[n, r] = sum(sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$quote),
sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$quote))/2
}else{break}
r = r - 1
}
prof_ocul203[n, 1] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 2] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(1,11)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 3] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(2,12)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 4] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(3,13)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 5] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(4,14)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 6] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(5,15)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 7] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(6,16)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 8] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(7,17)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 9] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(8,18)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 10] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(9,19)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul203[n, 11] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(10,20)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
n = n + 1
}
}
cont = 0
stock = read_tsv("Stock103LOB.txt")
#Se crean todas las variables que serán necesarias en el algoritmo
hor_rel103 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
prof103 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 4)
prof_ocul103 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 11)
q = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 1)
a = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
b = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
n = 1
#Cálculo horquilla relativa
for (i in 1:length(unique(stock$date))){
for (j in 1:length(unique(stock$time))){
#Variable creada para facilitar el almacenamiento en la matriz
m=1
#Cálculo del punto medio.
for(l in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign > 0),][l,]$dvol != 0){
for(p in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$dvol != 0){
q[n] = (stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$quote)/2
break
}
}
break
}
}
for (k in c(100,500,1000)){
for(l in 1:10){
#Cálculo del bid ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$hvol)  >= k){
b[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol)))/k
break
}else if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3] == -1){
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3])){break}
for(l in 1:10){
#Cálculo ask ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$hvol)  >= k){
a[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol)))/k
break
}else{
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
#Cálculo de la horquilla relativa
hor_rel103[n, m] = (a[n, m] - b[n, m])/q[n]
m = m + 1
}
cont = cont + 1
print(cont)
#Cálculo de la profundidad cotizada
r = 4
for (k in c(0.2, 0.1, 0.05, 0.01)){
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),][1,1]) == F &
is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),][1,1]) == F){
prof103[n, r] = sum(sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$quote),
sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$quote))/2
}else{break}
r = r - 1
}
prof_ocul103[n, 1] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 2] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(1,11)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 3] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(2,12)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 4] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(3,13)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 5] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(4,14)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 6] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(5,15)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 7] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(6,16)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 8] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(7,17)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 9] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(8,18)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 10] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(9,19)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul103[n, 11] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(10,20)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
n = n + 1
}
}
cont = 0
library(tidyverse)
stock = read_tsv("Stock102LOB.txt")
#Se crean todas las variables que serán necesarias en el algoritmo
hor_rel102 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
prof102 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 4)
prof_ocul102 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 11)
q = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 1)
a = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
b = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
n = 1
#Cálculo horquilla relativa
for (i in 1:length(unique(stock$date))){
for (j in 1:length(unique(stock$time))){
#Variable creada para facilitar el almacenamiento en la matriz
m=1
#Cálculo del punto medio.
for(l in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign > 0),][l,]$dvol != 0){
for(p in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$dvol != 0){
q[n] = (stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$quote)/2
break
}
}
break
}
}
for (k in c(100,500,1000)){
for(l in 1:10){
#Cálculo del bid ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$hvol)  >= k){
b[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol)))/k
break
}else if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3] == -1){
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3])){break}
for(l in 1:10){
#Cálculo ask ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$hvol)  >= k){
a[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol)))/k
break
}else{
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
#Cálculo de la horquilla relativa
hor_rel102[n, m] = (a[n, m] - b[n, m])/q[n]
m = m + 1
}
cont = cont + 1
print(cont)
#Cálculo de la profundidad cotizada
r = 4
for (k in c(0.2, 0.1, 0.05, 0.01)){
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),][1,1]) == F &
is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),][1,1]) == F){
prof102[n, r] = sum(sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$quote),
sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$quote))/2
}else{break}
r = r - 1
}
prof_ocul102[n, 1] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 2] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(1,11)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 3] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(2,12)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 4] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(3,13)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 5] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(4,14)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 6] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(5,15)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 7] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(6,16)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 8] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(7,17)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 9] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(8,18)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 10] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(9,19)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul102[n, 11] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(10,20)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
n = n + 1
}
}
cont = 0
stock = read_tsv("Stock101LOB.txt")
#Se crean todas las variables que serán necesarias en el algoritmo
hor_rel101 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
prof101 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 4)
prof_ocul101 = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 11)
q = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 1)
a = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
b = matrix(nrow = (length(unique(stock$date)) * length(unique(stock$time))), ncol = 3)
n = 1
#Cálculo horquilla relativa
for (i in 1:length(unique(stock$date))){
for (j in 1:length(unique(stock$time))){
#Variable creada para facilitar el almacenamiento en la matriz
m=1
#Cálculo del punto medio.
for(l in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign > 0),][l,]$dvol != 0){
for(p in 1:10){
if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$dvol != 0){
q[n] = (stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign == -p),]$quote)/2
break
}
}
break
}
}
for (k in c(100,500,1000)){
for(l in 1:10){
#Cálculo del bid ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l,]$hvol)  >= k){
b[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][1:l-1,]$hvol)))/k
break
}else if(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3] == -1){
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][l,3])){break}
for(l in 1:10){
#Cálculo ask ponderado
if(sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l,]$hvol)  >= k){
a[n, m] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$quote *
(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol),
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][l,]$quote *
(k - sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$sign < 0),][1:l-1,]$hvol)))/k
break
}else{
#stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),][,3] = NA
}
}
#Cálculo de la horquilla relativa
hor_rel101[n, m] = (a[n, m] - b[n, m])/q[n]
m = m + 1
}
cont = cont + 1
print(cont)
#Cálculo de la profundidad cotizada
r = 4
for (k in c(0.2, 0.1, 0.05, 0.01)){
if(is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),][1,1]) == F &
is.na(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),][1,1]) == F){
prof101[n, r] = sum(sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote > q[n] & stock$quote < q[n] + k),]$quote),
sum((stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$dvol +
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$hvol) *
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i] & stock$quote < q[n] & stock$quote > q[n] - k),]$quote))/2
}else{break}
r = r - 1
}
prof_ocul101[n, 1] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 2] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(1,11)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 3] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(2,12)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 4] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(3,13)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 5] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(4,14)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 6] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(5,15)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 7] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(6,16)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 8] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(7,17)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 9] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(8,18)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 10] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(9,19)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
prof_ocul101[n, 11] = sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol[c(10,20)]) /
sum(stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$dvol,
stock[which(stock$time == unique(stock$time)[j] & stock$date == unique(stock$date)[i]),]$hvol)
n = n + 1
}
}
